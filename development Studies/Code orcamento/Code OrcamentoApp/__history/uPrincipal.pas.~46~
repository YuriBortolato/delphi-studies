unit uPrincipal;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes, System.Variants,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs, FMX.Layouts,
  FMX.StdCtrls, FMX.Controls.Presentation, FMX.Objects, FMX.TabControl,
  uDesconto;

type
  TForm1 = class(TForm)
    lblTotal: TLabel;
    TabControl1: TTabControl;

    // --- COMPONENTES VISUAIS ---
    TabGastronomico: TTabItem;
    TabGerencial: TTabItem;
    VertScrollBoxGastro: TVertScrollBox;
    VertScrollBoxGerencial: TVertScrollBox;

    // --- GASTRONÔMICO ---
    chkMesa: TCheckBox;
    chkEntrega: TCheckBox;
    chkFiscal: TCheckBox;
    chkGerencePlus: TCheckBox;
    chkWhatsapp: TCheckBox;
    chkComeraqui: TCheckBox;
    chkFinanceiro: TCheckBox;
    chkDre: TCheckBox;
    chkDashboard: TCheckBox;
    chkIfood: TCheckBox;
    chkAiqfome: TCheckBox;
    chkDeliveryDireto: TCheckBox;

    lblQtdTerminais: TLabel;
    btnMenos: TRectangle;
    btnMais: TRectangle;

    // --- GERENCIAL ---
    chkFiscalGerencial: TCheckBox;
    chkFinanceiroGerencial: TCheckBox;
    chkDreGerencial: TCheckBox;
    chkDashboardGerencial: TCheckBox;
    chkGerenceRep: TCheckBox;

    lblQtdTerminaisGerencial: TLabel;
    btnMenosGerencial: TRectangle;
    btnMaisGerencial: TRectangle;

    // Label do preço antigo
    lblPrecoAntigo: TLabel;
    Layout11: TLayout;
    Layout12: TLayout;

    // Eventos
    procedure FormCreate(Sender: TObject);
    procedure CalcularEvent(Sender: TObject);
    procedure TabControl1Change(Sender: TObject);

    // Botões Gastro
    procedure btnMaisClick(Sender: TObject);
    procedure btnMenosClick(Sender: TObject);

    // Botões Gerencial
    procedure btnMaisGerencialClick(Sender: TObject);
    procedure btnMenosGerencialClick(Sender: TObject);

    // Clique no cabeçalho
    procedure lblTotalClick(Sender: TObject);

  private
    FQtdTerminaisGastro: Integer;
    FQtdTerminaisGerencial: Integer;
    FValorDesconto: Currency;

    procedure CalcularTudo;
    function CalcularGastronomico: Currency;
    function CalcularGerencial: Currency;
  public
  end;

var
  Form1: TForm1;

implementation

{$R *.fmx}


// CONFIGURAÇÕES DE PREÇOS E REGRAS
const
  BASE_GASTRO = 127.00;
  MIN_TERM_GASTRO = 1;

  BASE_GERENCIAL = 180.00;
  MIN_TERM_GERENCIAL = 1;

  VALOR_EXTRA_TERMINAL = 17.00;


// INICIALIZAÇÃO SEGURA (ANTI-CRASH)
procedure TForm1.FormCreate(Sender: TObject);
begin
  // Variáveis de memória
  FQtdTerminaisGastro := MIN_TERM_GASTRO;
  FQtdTerminaisGerencial := MIN_TERM_GERENCIAL;
  FValorDesconto := 0;

  // Atualiza visual com proteção
  if Assigned(lblQtdTerminais) then
    lblQtdTerminais.Text := FQtdTerminaisGastro.ToString;

  if Assigned(lblQtdTerminaisGerencial) then
    lblQtdTerminaisGerencial.Text := FQtdTerminaisGerencial.ToString;

  // Esconde o label de preço antigo no começo
  if Assigned(lblPrecoAntigo) then
    lblPrecoAntigo.Visible := False;

  // Tenta ativar a aba inicial
  if Assigned(TabControl1) and Assigned(TabGastronomico) then
  begin
    try
      TabControl1.ActiveTab := TabGastronomico;
    except
      // Ignora erro silenciosamente
    end;
  end;

  CalcularTudo;
end;


// CÁLCULO GERAL E VISUAL "DE / POR"
procedure TForm1.CalcularTudo;
var
  SubTotal, TotalFinal: Currency;
begin
  SubTotal := 0;

  // Descobre o valor cheio (Sem desconto)
  if Assigned(TabControl1) and (TabControl1.ActiveTab = TabGerencial) then
    SubTotal := CalcularGerencial
  else
    SubTotal := CalcularGastronomico;

  // Aplica o desconto
  TotalFinal := SubTotal - FValorDesconto;
  if TotalFinal < 0 then TotalFinal := 0;

  // Atualiza a tela (Label Principal)
  if Assigned(lblTotal) then
  begin
    lblTotal.Text := FormatFloat('R$ #,##0.00 | mês', TotalFinal);
  end;

  // Lógica do Label "Preço Antigo" (Riscado)
  if Assigned(lblPrecoAntigo) then
  begin
    if FValorDesconto > 0 then
    begin
      // Mostra o antigo riscado
      lblPrecoAntigo.Visible := True;
      // Dica visual: "De R$ 144,00 por"
      lblPrecoAntigo.Text := 'De ' + FormatFloat('R$ #,##0.00', SubTotal) + ' por';

      lblPrecoAntigo.TextSettings.Font.Style := [TFontStyle.fsStrikeOut];
    end
    else
    begin
      // Não tem desconto? Esconde.
      lblPrecoAntigo.Visible := False;
    end;
  end;
end;


// CÁLCULOS ESPECÍFICOS
function TForm1.CalcularGastronomico: Currency;
var
  Total: Currency;
begin
  Total := 0;

  // Regra: Cobra o base. Se tiver terminais EXTRAS (além do mínimo), cobra +17 cada.
  if FQtdTerminaisGastro <= MIN_TERM_GASTRO then
    Total := BASE_GASTRO
  else
    Total := BASE_GASTRO + ((FQtdTerminaisGastro - MIN_TERM_GASTRO) * VALOR_EXTRA_TERMINAL);

  // Módulos
  if Assigned(chkMesa) and chkMesa.IsChecked           then Total := Total + 17.00;
  if Assigned(chkEntrega) and chkEntrega.IsChecked     then Total := Total + 17.00;
  if Assigned(chkFiscal) and chkFiscal.IsChecked       then Total := Total + 47.00;
  if Assigned(chkGerencePlus) and chkGerencePlus.IsChecked then Total := Total + 47.00;
  if Assigned(chkWhatsapp) and chkWhatsapp.IsChecked   then Total := Total + 47.00;
  if Assigned(chkComeraqui) and chkComeraqui.IsChecked then Total := Total + 47.00;
  if Assigned(chkFinanceiro) and chkFinanceiro.IsChecked then Total := Total + 27.00;
  if Assigned(chkDre) and chkDre.IsChecked             then Total := Total + 27.00;
  if Assigned(chkDashboard) and chkDashboard.IsChecked then Total := Total + 27.00;
  if Assigned(chkIfood) and chkIfood.IsChecked         then Total := Total + 27.00;
  if Assigned(chkAiqfome) and chkAiqfome.IsChecked     then Total := Total + 27.00;
  if Assigned(chkDeliveryDireto) and chkDeliveryDireto.IsChecked then Total := Total + 17.00;

  Result := Total;
end;

function TForm1.CalcularGerencial: Currency;
var
  Total: Currency;
begin
  Total := 0;

  if FQtdTerminaisGerencial <= MIN_TERM_GERENCIAL then
    Total := BASE_GERENCIAL
  else
    Total := BASE_GERENCIAL + ((FQtdTerminaisGerencial - MIN_TERM_GERENCIAL) * VALOR_EXTRA_TERMINAL);

  if Assigned(chkFiscalGerencial) and chkFiscalGerencial.IsChecked     then Total := Total + 47.00;
  if Assigned(chkFinanceiroGerencial) and chkFinanceiroGerencial.IsChecked then Total := Total + 27.00;
  if Assigned(chkDreGerencial) and chkDreGerencial.IsChecked        then Total := Total + 27.00;
  if Assigned(chkDashboardGerencial) and chkDashboardGerencial.IsChecked  then Total := Total + 27.00;
  if Assigned(chkGerenceRep) and chkGerenceRep.IsChecked          then Total := Total + 47.00;

  Result := Total;
end;


// JANELA DE DESCONTO
procedure TForm1.lblTotalClick(Sender: TObject);
var
  LForm: TFrmDesconto;
  ValorAtualSemDesconto: Currency;
begin
  if Assigned(TabControl1) and (TabControl1.ActiveTab = TabGerencial) then
    ValorAtualSemDesconto := CalcularGerencial
  else
    ValorAtualSemDesconto := CalcularGastronomico;

  LForm := TFrmDesconto.Create(nil);
  try
    LForm.ValorOriginal := ValorAtualSemDesconto;
    if FValorDesconto > 0 then
       LForm.edtDesconto.Text := FloatToStr(FValorDesconto);

    LForm.ShowModal(procedure(ModalResult: TModalResult)
    begin
      if ModalResult = mrOk then
      begin
        FValorDesconto := ValorAtualSemDesconto - LForm.ValorFinal;
        CalcularTudo;
      end;
      TThread.ForceQueue(nil, procedure begin LForm.DisposeOf; end);
    end);
  except
    LForm.DisposeOf;
  end;
end;


// EVENTOS
procedure TForm1.TabControl1Change(Sender: TObject);
begin
  FValorDesconto := 0; // Zera desconto ao mudar de aba
  CalcularTudo;
end;

procedure TForm1.CalcularEvent(Sender: TObject);
begin
  CalcularTudo;
end;

// Botões Gastro
procedure TForm1.btnMaisClick(Sender: TObject);
begin
  Inc(FQtdTerminaisGastro);
  if Assigned(lblQtdTerminais) then
    lblQtdTerminais.Text := FQtdTerminaisGastro.ToString;
  CalcularTudo;
end;

procedure TForm1.btnMenosClick(Sender: TObject);
begin
  if FQtdTerminaisGastro > MIN_TERM_GASTRO then
  begin
    Dec(FQtdTerminaisGastro);
    if Assigned(lblQtdTerminais) then
      lblQtdTerminais.Text := FQtdTerminaisGastro.ToString;
    CalcularTudo;
  end;
end;

// Botões Gerencial
procedure TForm1.btnMaisGerencialClick(Sender: TObject);
begin
  Inc(FQtdTerminaisGerencial);
  if Assigned(lblQtdTerminaisGerencial) then
    lblQtdTerminaisGerencial.Text := FQtdTerminaisGerencial.ToString;
  CalcularTudo;
end;

procedure TForm1.btnMenosGerencialClick(Sender: TObject);
begin
  if FQtdTerminaisGerencial > MIN_TERM_GERENCIAL then
  begin
    Dec(FQtdTerminaisGerencial);
    if Assigned(lblQtdTerminaisGerencial) then
       lblQtdTerminaisGerencial.Text := FQtdTerminaisGerencial.ToString;
    CalcularTudo;
  end;
end;

end.
